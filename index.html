<!DOCTYPE html>
<html>

<head>
    <title>Pavlovian Study</title>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
    <script src="jsPsych/jspsych.js" charset="utf-8"></script>
    <script src="plugins/jspsych-instructions.js" charset="utf-8"></script>
    <script src="jsPsych/plugins/jspsych-fullscreen.js" charset="utf-8"></script>
    <script src="jsPsych/plugins/jspsych-html-keyboard-response.js" charset="utf-8"></script>
    <script src="jsPsych/plugins/jspsych-image-keyboard-response.js" charset="utf-8"></script>
    <script src="jsPsych/plugins/jspsych-survey-multi-select.js" charset="utf-8"></script>
    <script src="jsPsych/plugins/jspsych-survey-text.js" charset="utf-8"></script>
    <link href="jsPsych/css/jspsych.css" rel="stylesheet" type="text/css">
    </link>
    <link href="study.css" rel="stylesheet" type="text/css">
    </link>
</head>

<body>
    <script>
        var debug = true;
        /* create timeline */
        var timeline = [];

        /* ========= PARAMETERS ==================== */
        var ntraining=5; // number of training trials
        var ntrials = 40; // number of full trials
        var gocost=0; // go-cost (added to reward in case of go)
        var pwin_if_correct=0.8; // win-contingency
        var rew_magnitude=10; // reward magnitude (multiplied by -1 for losses)

        var duration_fixation=1000;
        var duration_ticket=1000;
        var duration_prompt=1000;
        var duration_feedback=1000;
        /* ========= /PARAMETERS ==================== */

        var expid="pavgonogo_online";
        var subject = jsPsych.randomization.randomID(12);
        var datetime=Date().toLocaleString();
        // record the condition assignment in the jsPsych data
        // this adds a property called 'subject' to every trial
        jsPsych.data.addProperties({
            subject: subject,
            date: datetime
        });

        // data is being sent to sigmund for storage
        function saveData(name, data) {
            var xhr = new XMLHttpRequest();
            xhr.open('POST', 'http://sigmund.hsl.uit.no/storedata.php'); // 'write_data.php' is the path to the php file described above.
            xhr.setRequestHeader('Content-Type', 'application/json');
            xhr.send(JSON.stringify({ filename: name, filedata: data }));
        }

        if (!debug) {
            timeline.push({
                type: "fullscreen",
                fullscreen_mode: true,
                message: "Welcome! <p>We will now use your entire screen so that you are not distracted by other things.<p>",
                button_label: "Fortsett"
            });
        }
        var instructions1 = {
            type: "instructions",
            pages: [
                "<div class='instructions'><H1>Welcome to the experiment!</H1><p>\
                    Please sit comfortably ca 60cm from the screen.<p>\
                    While conducting the experiment, you are not allowed to switch windows or do other things on your PC. If you switch windows during the experiment, the experiment will end automatically and you will be prompted to restart.<p>\
                    Press next to continue.</div>",
                "<div class='instructions'><p> \
                    You will play a card game consisting of 160 trials. <p>\
                    On each trial, you will be presented with one of four cards. You can choose to pick it up by pressing space or not do anything while you see the question mark. (Your response will only get registered during the question mark.) <p>\
                    The combination of a specific card and your action/inaction will earn you points at the end of each trial. <p>\
                    Two of the cards are 'winning cards' which means, the optimal outcome is winning 10 points and the alternative is not getting anything. The remaining two cards are 'losing cards' for which the optimal outcome is not losing anything (0 points) and the alternative is losing 10 points. <p>\
                    You should learn which response is correct for each card to maximize your earnings in following trials. <p>\
                    The task is made more difficult by probabilistic outcomes.<p>\
                    That means that responding correctly will not guarantee you the optimal outcome. Rather, it will increase the probability of you receiving it. Respectively, the wrong response will decrease the probability of the optimal outcome. <p>\
                    There will therefore be some confusing trials but the outcomes are not completely random so you should be able to learn after a number of trials.<p>\
                    The task is rather difficult but it is important that you do not give up. Try to find the best strategy to collect as many points as possible! <p>\
                    Good luck! <p>\
                    Press next to start the prectise session.</div>"

            ],
            show_clickable_nav: true,
            button_label_previous: "back",
            button_label_next: "next"
        };
        var instructions2 = {
            type: "instructions",
            pages: [
                "<div class='instructions'><H1>Good luck!</H1><p>\
                    Now the actual experiment will start. <p>\
                    Press next to start the experiment.</div>"
            ],
            show_clickable_nav: true,
            button_label_previous: "back",
            button_label_next: "next"
        };
        timeline.push(instructions1);

        var conditions = ["gowin", "nogowin", "goavoid", "nogoavoid"];
        var ticket_imgs= ["pics_cards/1.png", "pics_cards/2.png", "pics_cards/3.png", "pics_cards/4.png"];
        var condition_to_ticket = {
            "gowin": "pics_cards/1.png",
            "nogowin": "pics_cards/2.png",
            "goavoid": "pics_cards/3.png",
            "nogoavoid": "pics_cards/4.png"
        }
        var condition_to_response = {
            "gowin": "go",
            "nogowin": "nogo",
            "goavoid":"go",
            "nogoavoid":"nogo"
        };
        var condition_to_winavoid = {
            "gowin": "win",
            "nogowin": "win",
            "goavoid":"avoid",
            "nogoavoid":"avoid"
        };

        var go_button = 'space';

        /* ========= TRIAL DEFINITION ==================== */
        var fixation = {
            type: 'html-keyboard-response',
            stimulus: '<div style="font-size:60px;">+</div>',
            trial_index: jsPsych.timelineVariable('trial_index'),
            choices: jsPsych.NO_KEYS,
            trial_duration: duration_fixation,
            data: jsPsych.timelineVariable('data'),
            on_finish: function (data) {
                data.trial_part="fixation";
            }
        }
        var ticket = {
            type: "html-keyboard-response",
            stimulus: jsPsych.timelineVariable('stimulus'),
            choices: jsPsych.NO_KEYS,
            trial_duration: duration_ticket,
            data: jsPsych.timelineVariable('data'),
            on_finish: function (data) {
                data.trial_part="ticket";
            }
        }
        var prompt = {
            type: "html-keyboard-response",
            stimulus: '<div style="font-size:60px;">?</div>',
            choices: [go_button],
            trial_duration: duration_prompt,
            response_ends_trial: false,
            data: jsPsych.timelineVariable('data'),
            on_finish: function (data) {
                data.trial_part="prompt";
                var resp;
                if(data.key_press===null){
                    resp="nogo";
                } else {
                    resp="go";
                }
                data.response=resp;
                data.correct=condition_to_response[data.condition]==resp;

                // calculate reward
                data.win_if_correct=jsPsych.randomization.sampleWithReplacement([0,1],1,
                                [1-pwin_if_correct, pwin_if_correct])[0];
                var reward=0;
                if(data.response=="go"){
                    reward+=gocost;
                    if(data.condition=="gowin"){
                        reward+=data.win_if_correct*rew_magnitude;
                    } else if (data.condition=="goavoid"){
                        reward+=(1-data.win_if_correct)*(-1)*rew_magnitude;
                    } else if (data.condition=="nogowin"){
                        reward+=(1-data.win_if_correct)*rew_magnitude;
                    } else if (data.condition=="nogoavoid"){
                        reward+=data.win_if_correct*(-1)*rew_magnitude;
                    }
                } else {
                    if(data.condition=="gowin"){
                        reward+=(1-data.win_if_correct)*rew_magnitude;
                    } else if (data.condition=="goavoid"){
                        reward+=(data.win_if_correct)*(-1)*rew_magnitude;
                    } else if (data.condition=="nogowin"){
                        reward+=(data.win_if_correct)*rew_magnitude;
                    } else if (data.condition=="nogoavoid"){
                        reward+=(1-data.win_if_correct)*(-1)*rew_magnitude;
                    }
                }
                data.reward=reward;
                saveData(expid+"_"+subject, jsPsych.data.get().csv());
            }
        }

        var feedback = {
            type: 'html-keyboard-response',
            trial: jsPsych.timelineVariable('trial'),
            stimulus: function () {
                var d = jsPsych.data.getLastTimelineData().last(3).values()[1];
                //console.log(JSON.stringify(d))

                fb = '<div style="font-size:60px;">'
                fb += d.reward;
                fb += "</div>"
                return (fb);
            },
            choices: jsPsych.NO_KEYS,
            trial_duration: duration_feedback,
            post_trial_gap: 0,
            data: jsPsych.timelineVariable('data'),
            on_finish: function (data) {
                data.trial_part="feedback";
            }
        }
        /* ========= /TRIAL DEFINITION ==================== */

        /* ========= TRAINING  DEFINITION ==================== */

        /* ========= /TRAINING DEFINITION ==================== */

        /* ========= EXPERIMENT DEFINITION ==================== */
        var factors = {
            condition: conditions
        }
        var design = jsPsych.randomization.factorial(factors, ntrials);
        for (var i = 0; i < design.length; ++i) {
            var stim = "<div style='font-size:60px;'>";
            stim+="<img src='"+ condition_to_ticket[design[i].condition]+"'>";
            stim+="</div>";
            design[i].stimulus = stim;
            design[i].trial=i;
            design[i].data = {
                trial:i+1,
                condition:design[i].condition,
                gonogo: condition_to_response[design[i].condition],
                winavoid: condition_to_winavoid[design[i].condition],
                training: 0
            }
        }

        var exp_block = {
            timeline: [fixation, ticket, prompt, fixation, feedback],
            timeline_variables: design
        }
        timeline.push(exp_block);
        /* ========= /EXPERIMENT DEFINITION ==================== */


        // FINALIZE
        //==================================================================================
        if (!debug) {
            timeline.push({
                type: "fullscreen",
                fullscreen_mode: false,
                message: "Thank you for participating!<p>Press 'exit' to exit the full-screen mode.",
                button_label: "exit"
            });
        }

         /* start the experiment */
        jsPsych.init({
            timeline: timeline,
            on_finish: function () {
                jsPsych.data.displayData();
            },
            on_interaction_data_update: function (data) {
                console.log(JSON.stringify(data))
                if(data.event=="blur"){
                    jsPsych.pauseExperiment();
                } else if(data.event=="focus"){
                    jsPsych.resumeExperiment();
                }
                iadata=jsPsych.data.getInteractionData()
                saveData(expid+"_"+subject+"_interactiondata", iadata.csv());
            }
        });

        function getRandomInt(min, max) {
            min = Math.ceil(min);
            max = Math.floor(max);
            return Math.floor(Math.random() * (max - min + 1)) + min;
        }
    </script>
</body>

</html>